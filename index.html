<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GPS Tracker</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<h2>GPS Tracker</h2>
<button onclick="saveLocation()">Save Location</button>

<!-- แผนที่ -->
<div id="map" style="height: 500px; width: 100%; margin-top:20px;"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  // ===== Firebase Import =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ===== ใส่ค่า Firebase ของคุณตรงนี้ =====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_ID",
    appId: "YOUR_APP_ID"
  };

  // ===== Initialize Firebase ครั้งเดียว =====
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== บันทึก GPS =====
  window.saveLocation = function() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        await addDoc(collection(db, "locations"), {
          latitude: lat,
          longitude: lng,
          timestamp: serverTimestamp()
        });

        alert("บันทึกตำแหน่งเรียบร้อยแล้ว");
        loadMap(); // รีโหลดหมุดใหม่
      });
    } else {
      alert("เบราว์เซอร์ไม่รองรับ GPS");
    }
  };

  // ===== โหลดแผนที่ =====
  async function loadMap() {
    const querySnapshot = await getDocs(collection(db, "locations"));

    if (querySnapshot.empty) return;

    let firstLocation = null;
    const locations = [];

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      locations.push(data);
      if (!firstLocation) firstLocation = data;
    });

    // สร้างแผนที่
    const map = L.map('map').setView(
      [firstLocation.latitude, firstLocation.longitude],
      15
    );

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // วางหมุดทั้งหมด
    locations.forEach((data) => {
      L.marker([data.latitude, data.longitude])
        .addTo(map)
        .bindPopup("พิกัด: " + data.latitude + ", " + data.longitude);
    });
  }

  // โหลดแผนที่ตอนเปิดเว็บ
  loadMap();

</script>

</body>
</html>
